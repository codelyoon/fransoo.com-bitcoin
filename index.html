<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>fransoo.com | Crypto Portal</title>
<style>
  body{background:#000;color:#00bfff;font-family:'Courier New',monospace;margin:0;height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;overflow:hidden}
  #static{position:absolute;inset:0;opacity:0.15;pointer-events:none;z-index:1}
  .container{z-index:2;width:100%;max-width:1100px;padding:10px;box-sizing:border-box;display:flex;flex-direction:column;align-items:center}
  .typing{font-size:clamp(16px,4vw,22px);white-space:pre-line;text-align:center;margin-bottom:8px}
  .cursor{display:inline-block;width:10px;height:1.2em;background:#00bfff;animation:b 1s infinite;vertical-align:middle}
  @keyframes b{0%,50%{opacity:1}51%,100%{opacity:0}}
  
  #price-box{display:flex;align-items:center;gap:15px;font-size:clamp(30px,8vw,42px);font-weight:bold;z-index:10;text-shadow:0 0 15px #00bfff;position:relative}
  #coin-display{font-weight:bold;color:#00bfff}
  #coin-select{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}
  #price-live{transition:background 0.4s}
  .pulse-green{background:rgba(0,255,0,0.3)!important}
  .pulse-red{background:rgba(255,0,0,0.3)!important}
  .up{color:#0f8}.down{color:#f44}
  
  #chart-container{position:relative;width:100%;max-width:1100px;height:60vh;border:1px solid #00bfff;background:#000;margin:10px 0}
  canvas{width:100%!important;height:100%!important;display:block}
  #tf-select{position:absolute;top:12px;left:12px;z-index:10;background:#000;border:1px solid #00bfff;color:#00bfff;padding:10px 18px;font-size:16px;border-radius:6px}
  #change{font-size:clamp(17px,4.5vw,21px);margin-top:10px;font-weight:bold}
</style>
</head>
<body>
<canvas id="static"></canvas>

<div class="container">
  <div class="typing" id="typing"></div>
  
  <div id="price-box">
    <div id="coin-display">BTC</div>
    <select id="coin-select"></select>
    <span id="price-live">Loading...</span>
  </div>

  <div id="chart-container">
    <select id="tf-select">
      <option value="live">LIVE</option>
      <option value="1h">1H</option>
      <option value="1d">1D</option>
      <option value="7d" selected>7D</option>
      <option value="30d">30D</option>
      <option value="ytd">YTD</option>
      <option value="all">ALL</option>
    </select>
    <canvas id="c"></canvas>
  </div>
  
  <div id="change">Loading...</div>
</div>

<script>
// Static noise + typing (unchanged)
const s=document.getElementById('static'),ctx2=s.getContext('2d');
s.width=innerWidth;s.height=innerHeight;
window.addEventListener('resize',()=>{s.width=innerWidth;s.height=innerHeight});
(function n(){const i=ctx2.createImageData(s.width,s.height),d=new Uint32Array(i.data.buffer);
for(let j=0;j<d.length;j++)if(Math.random()<0.09)d[j]=0x33ffffff;ctx2.putImageData(i,0,0);requestAnimationFrame(n)})();

const intro=`welcome to the fransoo.com crypto portal

live charts • top 30 coins • real-time`;
const typing=document.getElementById('typing');
let i=0;
const ti=setInterval(()=>{if(i<intro.length){typing.innerHTML+=intro[i]==='\n'?'<br>':intro[i];i++}
else{clearInterval(ti);typing.innerHTML+='<span class="cursor"></span>'}},45);

const canvas=document.getElementById('c'),ctx=canvas.getContext('2d');
const priceLive=document.getElementById('price-live');
const changeEl=document.getElementById('change');
const coinDisplay=document.getElementById('coin-display');
const coinSel=document.getElementById('coin-select');
const tfSel=document.getElementById('tf-select');

let currentSymbol = 'BTCUSDT';
let currentName = 'BTC';
let lastPrice = 0;
let currentPrice = 0;
let chartData = {prices: [], times: []};
let lastCandleTime = 0;
let currentTf = '7d';

const top30 = [
  {s:'BTCUSDT',n:'BTC'},{s:'ETHUSDT',n:'ETH'},{s:'BNBUSDT',n:'BNB'},{s:'SOLUSDT',n:'SOL'},
  {s:'XRPUSDT',n:'XRP'},{s:'ADAUSDT',n:'ADA'},{s:'DOGEUSDT',n:'DOGE'},{s:'TRXUSDT',n:'TRX'},
  {s:'AVAXUSDT',n:'AVAX'},{s:'SHIBUSDT',n:'SHIB'},{s:'LINKUSDT',n:'LINK'},{s:'DOTUSDT',n:'DOT'},
  {s:'LTCUSDT',n:'LTC'},{s:'BCHUSDT',n:'BCH'},{s:'NEARUSDT',n:'NEAR'},{s:'HBARUSDT',n:'HBAR'},
  {s:'MATICUSDT',n:'MATIC'},{s:'UNIUSDT',n:'UNI'},{s:'ICPUSDT',n:'ICP'},{s:'APTUSDT',n:'APT'},
  {s:'CROUSDT',n:'CRO'},{s:'XLMUSDT',n:'XLM'},{s:'VETUSDT',n:'VET'},{s:'FILUSDT',n:'FIL'},
  {s:'KASUSDT',n:'KAS'},{s:'ATOMUSDT',n:'ATOM'},{s:'STXUSDT',n:'STX'},{s:'ARBUSDT',n:'ARB'},
  {s:'IMXUSDT',n:'IMX'},{s:'SUIUSDT',n:'SUI'}
];

function resize(){
  canvas.width=canvas.offsetWidth*devicePixelRatio;
  canvas.height=canvas.offsetHeight*devicePixelRatio;
  ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
}
window.addEventListener('resize',resize);resize();

async function safeFetch(url){
  try{
    const r = await fetch(url,{cache:"no-store"});
    if(!r.ok) return null;
    return await r.json();
  }catch{return null}
}

async function updateDropdown(){
  for(let i=0;i<top30.length;i++){
    const coin = top30[i];
    const data = await safeFetch(`https://api.binance.com/api/v3/ticker/24hr?symbol=${coin.s}`);
    if(data){
      const change = +data.priceChangePercent;
      coinSel.options[i].textContent = `${coin.n} ${change>=0?'Up':'Down'} ${Math.abs(change).toFixed(2)}%`;
    }
  }
}

// Smart chart update — only adds new point when candle actually closes
async function updateLive(){
  const data = await safeFetch(`https://api.binance.com/api/v3/ticker/24hr?symbol=${currentSymbol}`);
  if(!data) return;

  const price = +data.lastPrice;
  const ch24 = +data.priceChangePercent;
  const now = Date.now();

  // Pulse price
  if(lastPrice !== 0 && price !== lastPrice){
    priceLive.classList.add(price > lastPrice ? 'pulse-green' : 'pulse-red');
    setTimeout(()=>priceLive.classList.remove('pulse-green','pulse-red'),500);
  }
  lastPrice = price;
  currentPrice = price;

  priceLive.innerHTML = `$${price.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})} <span class="${ch24>=0?'up':'down'}">${ch24>=0?'+' : '-'} ${Math.abs(ch24).toFixed(2)}%</span>`;

  // LIVE MODE: update every tick
  if(currentTf === 'live'){
    chartData.prices.push(price);
    chartData.times.push(new Date(now));
    if(chartData.prices.length > 300) { chartData.prices.shift(); chartData.times.shift(); }
    drawChart(chartData.prices, chartData.times, 'live', price > lastPrice ? '#0f8' : price < lastPrice ? '#f44' : '#00bfff');
    return;
  }

  // CANDLE MODE: only update on new candle
  const intervalMs = {
    '1h': 60*1000, '1d': 24*60*60*1000, '7d': 7*24*60*60*1000,
    '30d': 30*24*60*60*1000, 'ytd': 365*24*60*60*1000, 'all': 365*24*60*60*1000
  }[currentTf] || 60*60*1000;

  const candleTime = Math.floor(now / intervalMs) * intervalMs;
  if(candleTime !== lastCandleTime){
    lastCandleTime = candleTime;
    chartData.prices[chartData.prices.length-1] = price; // update current candle
    if(chartData.prices.length > 1) drawChart(chartData.prices, chartData.times, currentTf);
  } else if(chartData.prices.length > 0){
    chartData.prices[chartData.prices.length-1] = price;
    drawChart(chartData.prices, chartData.times, currentTf, price > lastPrice ? '#0f8' : price < lastPrice ? '#f44' : '#00bfff');
  }
}

async function loadChart(tf){
  currentTf = tf;
  let interval='1h', limit=168;
  if(tf==='live') { chartData = {prices: [], times: []}; return; }
  if(tf==='1h'){interval='1m';limit=60}
  else if(tf==='1d'){interval='5m';limit=288}
  else if(tf==='7d'){interval='1h';limit=168}
  else if(tf==='30d'){interval='4h';limit=180}
  else if(tf==='ytd'){interval='1d';limit=365}
  else{interval='1w';limit=1000}

  const data = await safeFetch(`https://api.binance.com/api/v3/klines?symbol=${currentSymbol}&interval=${interval}&limit=${limit}`);
  if(!data || data.length<2) return;

  chartData.prices = data.map(k=>+k[4]);
  chartData.times = data.map(k=>new Date(k[0]));
  lastCandleTime = Math.floor(Date.now() / (tf==='1h'?60*1000 : tf==='1d'?86400000 : 3600000)) * (tf==='1h'?60*1000 : tf==='1d'?86400000 : 3600000);

  const first=chartData.prices[0], last=chartData.prices[chartData.prices.length-1];
  const change = ((last-first)/first)*100;
  const tfName = tfSel.options[tfSel.selectedIndex].text;
  changeEl.innerHTML = `<span class="${change>=0?'up':'down'}">${change>=0?'+' : '-'} ${Math.abs(change).toFixed(2)}%</span> (${tfName})`;

  drawChart(chartData.prices, chartData.times, tf);
}

function drawChart(prices, times, tf, dotColor = '#00bfff'){
  resize();
  const W=canvas.width/devicePixelRatio, H=canvas.height/devicePixelRatio;
  ctx.clearRect(0,0,W,H);
  if(prices.length < 2) return;

  const padX=70, padY=50, cw=W-padX-110, ch=H-2*padY;
  const max=Math.max(...prices), min=Math.min(...prices), range=max-min||1;

  ctx.fillStyle='rgba(0,191,255,0.12)';
  ctx.beginPath();
  prices.forEach((p,i)=>{const x=padX+i*(cw/(prices.length-1));
    const y=H-padY-((p-min)/range)*ch;
    i===0?ctx.moveTo(x,y):ctx.lineTo(x,y)});
  ctx.lineTo(W-110,H-padY);ctx.lineTo(padX,H-padY);ctx.closePath();ctx.fill();

  ctx.strokeStyle='#00bfff';ctx.lineWidth=2.5;ctx.beginPath();
  prices.forEach((p,i)=>{const x=padX+i*(cw/(prices.length-1));
    const y=H-padY-((p-min)/range)*ch;
    i===0?ctx.moveTo(x,y):ctx.lineTo(x,y)});
  ctx.stroke();

  // Pulsing dot
  const lastX = padX + (prices.length-1)*(cw/(prices.length-1));
  const lastY = H-padY-((prices[prices.length-1]-min)/range)*ch;
  ctx.fillStyle = dotColor;
  ctx.beginPath(); ctx.arc(lastX, lastY, 7, 0, Math.PI*2); ctx.fill();
  ctx.strokeStyle = '#00bfff'; ctx.lineWidth = 2; ctx.stroke();

  // Time labels (disabled in LIVE mode)
  if(tf !== 'live'){
    ctx.fillStyle='#00bfff';ctx.font='14px monospace';ctx.textAlign='center';
    const count = innerWidth<=768?4:6;
    for(let i=0;i<=count;i++){
      const idx=Math.round(i*(prices.length-1)/count);
      const x=padX+idx*(cw/(prices.length-1));
      const d=times[idx];
      let label = tf==='1h' ? d.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'}).replace(/:\d\d$/,'') :
                  tf==='1d' ? d.getHours()+'h' :
                  tf==='7d'||tf==='30d' ? d.toLocaleDateString('en-US',{month:'short',day:'numeric'}) :
                  tf==='ytd' ? d.toLocaleDateString('en-US',{month:'short'}) : d.getFullYear();
      ctx.fillText(label,x,H-padY+28);
    }
  }

  ctx.strokeStyle='#00bfff';ctx.lineWidth=1.5;
  ctx.strokeRect(padX,padY,cw,ch);
}

// Events
coinSel.onchange = () => {
  const opt = coinSel.options[coinSel.selectedIndex];
  currentSymbol = coinSel.value;
  currentName = opt.textContent.split(' ')[0];
  coinDisplay.textContent = currentName;
  lastPrice = 0; chartData = {prices: [], times: []}; lastCandleTime = 0;
  loadChart(tfSel.value);
};
tfSel.onchange = () => loadChart(tfSel.value);

// Init
async function init(){
  coinSel.innerHTML = '';
  top30.forEach(coin => {
    const opt = document.createElement('option');
    opt.value = coin.s;
    opt.textContent = `${coin.n} Loading...`;
    if(coin.s===currentSymbol) opt.selected = true;
    coinSel.appendChild(opt);
  });
  updateDropdown();
  loadChart('7d');
}
init();

// Live loop
setInterval(updateLive, 3000);
setInterval(updateDropdown, 60000);
</script>
</body>
</html>
